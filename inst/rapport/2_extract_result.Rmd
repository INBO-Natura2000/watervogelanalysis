```{r extract-results}
year_month <- function(z) {
  if (has_name(z, "Month")) {
    as.character(interaction(z$Year, z$Month))
  } else {
    as.character(z$Year)
  }
}
extract_results <- function(hash, base, project, relevant) {
  message(hash)
  x <- try(read_model(hash, base = base, project = project))
  if (inherits(x, "try-error")) {
    return(tibble(FileFingerprint = hash, Status = "missing"))
  }
  if (inherits(x, "n2kAggregate")) {
    x@AnalysisMetadata %>%
      select(SpeciesGroupID, LocationGroupID, ModelType, Duration,
             FileFingerprint, StatusFingerprint, Status) %>%
      inner_join(x@AnalysisRelation, by = c("FileFingerprint" = "Analysis")) ->
      result
    if (x@AnalysisMetadata$Status == "converged") {
      switch(
        x@AnalysisMetadata$ModelType,
        "aggregate imputed: max ~ Year" = tibble(
          Parameter = as.character(x@AggregatedImputed@Covariate$Year),
          Estimate = rowMeans(x@AggregatedImputed@Imputation),
          LCL = apply(x@AggregatedImputed@Imputation, 1, quantile, 0.025),
          UCL = apply(x@AggregatedImputed@Imputation, 1, quantile, 0.975),
          FileFingerprint = hash
        ),
        "aggregate imputed: sum ~ Year + Month" = tibble(
          Parameter = year_month(x@AggregatedImputed@Covariate),
          Estimate = rowMeans(x@AggregatedImputed@Imputation),
          LCL = apply(x@AggregatedImputed@Imputation, 1, quantile, 0.025),
          UCL = apply(x@AggregatedImputed@Imputation, 1, quantile, 0.975),
          FileFingerprint = hash
        ),
        stop(x@AnalysisMetadata$ModelType)
      ) %>%
        inner_join(result, by = "FileFingerprint"
        ) -> result
    }
    relevant %>%
      filter(Parent == get_file_fingerprint(x)) %>%
      pull(Fingerprint) %>%
      lapply(extract_results, base = base, project = project, 
             relevant = relevant) %>%
      bind_rows(result) -> result
    return(result)
  }
  if (inherits(x, "n2kModelImputed")) {
    x@AnalysisMetadata %>%
      select(SpeciesGroupID, LocationGroupID, ModelType, Duration,
             FileFingerprint, StatusFingerprint, Status) %>%
      inner_join(x@AnalysisRelation, by = c("FileFingerprint" = "Analysis")) ->
      result
    if (x@AnalysisMetadata$Status == "converged") {
      result %>%
        inner_join(
          x@Results %>%
            mutate(
              FileFingerprint = hash,
              Parameter = as.character(Parameter)
            ),
          by = "FileFingerprint"
        ) -> result
    }
    return(result)
  }
  stop(class(x), " not handled")
}
```

```{r import-data, eval = !file.exists("results.Rds"), results = "hide", message = FALSE}
library(aws.s3)
library(n2kanalysis)

project <- "watervogels"
base <- get_bucket("n2kmonitoring", prefix = project, max = 1)

result_channel <- n2khelper::connect_result(
  username = Sys.getenv("N2KRESULT_USERNAME"),
  password = Sys.getenv("N2KRESULT_PASSWORD")
)

tbl(result_channel, "scheme") %>%
  filter(description == "Watervogels") %>%
  semi_join(x = tbl(result_channel, "species_group"),
            by = c("scheme" = "id")) %>%
  select(SpeciesGroupID = fingerprint, SpeciesGroup = description, id) %>%
  inner_join(
    tbl(result_channel, "species_group_species") %>%
      filter(is.na(destroy)) %>%
      select(species_group, species),
    by = c("id" = "species_group")
  ) %>%
  left_join(
    tbl(result_channel, "species") %>%
      select(id, scientific_name) %>%
      left_join(
        tbl(result_channel, "species_common_name") %>%
          filter(is.na(destroy)) %>%
          select(id = language, species, common_name = description) %>%
          inner_join(
            tbl(result_channel, "language") %>%
              select(id, language = description),
            by = "id"
          ) %>%
          select(-id),
        by = c("id" = "species")
      ),
    by = c("species" = "id")
  ) %>%
  arrange(SpeciesGroupID) %>%
  select(-id, -species) %>%
  collect() %>%
  spread(language, common_name) %>%
  mutate_at(c("SpeciesGroup", "scientific_name", "Nederlands"), factor) ->
  species_list

tbl(result_channel, "scheme") %>%
  filter(description == "Watervogels") %>%
  semi_join(x = tbl(result_channel, "location_group"),
            by = c("scheme" = "id")) %>%
  select(LocationGroupID = fingerprint, LocationGroup = description) %>%
  collect() %>%
  mutate(LocationGroup = str_replace(LocationGroup, "\\\\u0137", "ë") %>%
           factor()) ->
  location_group

sprintf("%s/manifest", project) %>%
  get_bucket_df(bucket = base) %>%
  select(Key, LastModified) %>%
  mutate(
    LastModified = as.POSIXct(LastModified, format = "%Y-%m-%dT%H:%M:%S")
  ) %>%
  filter(LastModified >= as.POSIXct("2019-04-01")) %>%
  mutate(
    manifest = str_extract(Key, "([[:xdigit:]]{40})") %>%
      map(read_manifest, base = base, project = project) %>%
      map(slot, "Manifest")
  ) %>%
  unnest() %>%
  group_by(Fingerprint) %>%
  arrange(desc(LastModified)) %>%
  slice(1) %>%
  ungroup() -> relevant

relevant %>%
  filter(is.na(Parent)) %>%
  semi_join(x = relevant, by = c("Parent" = "Fingerprint")) %>%
  arrange(Fingerprint) %>%
  mutate(results = map(Fingerprint, extract_results, base = base,
                       project = project, relevant = relevant)) %>%
  unnest() %>%
  inner_join(location_group, by = "LocationGroupID") %>%
  inner_join(species_list, by = "SpeciesGroupID") %>%
  mutate_at(c("Key", "Fingerprint", "Parent", "ModelType", "FileFingerprint",
              "StatusFingerprint", "Status", "ParentAnalysis",
              "ParentStatusFingerprint", "ParentStatus", "Parameter"),
            factor
  ) -> results
saveRDS(results, "results.Rds")
```

```{r read-data}
readRDS("results.Rds") -> results
results %>%
  distinct(LocationGroup, SpeciesGroup, ModelType, Duration, FileFingerprint, 
           LastModified) %>%
  group_by(LocationGroup, SpeciesGroup, ModelType, Duration) %>%
  arrange(desc(LastModified)) %>%
  ungroup() %>%
  semi_join(x = results, by = "FileFingerprint") %>%
  filter(Status != "error") %>%
  mutate(id = as.character(scientific_name) %>% 
           str_replace_all(" ", "-"),
         Parameter = as.character(Parameter)) -> results
levels(results$LocationGroup) %>%
  str_replace("België", "Belgium") %>%
  str_replace("Vlaanderen", "Flanders") %>%
  str_replace("Wallonië", "Wallonia") %>%
  str_replace("Vogelrichtlijn (.*)", "\\1 SPA") -> levels(results$LocationGroup)
results %>%
  mutate(
    loc_id = as.character(LocationGroup) %>%
      str_replace_all(" ", "-") %>%
      interaction(id, sep = "-")
  ) -> results
results %>%
  filter(ModelType == "imputed average: Total ~ cPeriod", 
         Parameter == "(Intercept)") %>%
  select(id, LocationGroup, Estimate, LCL, UCL) %>%
  mutate_at(c("Estimate", "LCL", "UCL"), exp) %>%
  mutate(
    Magnitude = floor(log10(UCL)),
    Magnitude = Magnitude - ifelse(UCL < 2 * 10 ^ Magnitude, 1, 0)
  ) %>%
  mutate_at(
    c(pEstimate = "Estimate", pLCL = "LCL", pUCL = "UCL"), 
    function(x, m) {
      round(x / 10 ^ m, 1) * 10 ^ m
    },
    .$Magnitude
  ) %>%
  mutate(
    Detailed = sprintf("%0.1f (%0.1f; %0.1f)", Estimate, LCL, UCL),
    `For publication` = sprintf("%s (%s; %s)", pEstimate, pLCL, pUCL)
  ) %>%
  select(-Magnitude) -> wintermax
```
